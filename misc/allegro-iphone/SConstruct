import os

# From elias's xcodebuild for iphone
# /Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/gcc-4.2 -x c -arch armv6 -fmessage-length=0 -pipe -Wno-trigraphs -fpascal-strings -O0 "-DCMAKE_INTDIR=\"Debug\"" -isysroot /Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS4.3.sdk -gdwarf-2 -mthumb -miphoneos-version-min=4.3 -I/Users/elias/prog/git5/build-iphone/lib/Debug/include -I/Users/elias/prog/git5/include -I/Users/elias/prog/git5/build-iphone/include -I/Users/elias/prog/git5/build-iphone/ALLEGRO.build/Debug-iphoneos/allegro.build/DerivedSources/armv6 -I/Users/elias/prog/git5/build-iphone/ALLEGRO.build/Debug-iphoneos/allegro.build/DerivedSources -Wmost -Wno-four-char-constants -Wno-unknown-pragmas -F/Users/elias/prog/git5/build-iphone/lib/Debug -std=gnu99 -W -Wall -DDEBUGMODE=1 -DD3D_DEBUG_INFO -DALLEGRO_SRC -DALLEGRO_STATICLINK -DALLEGRO_LIB_BUILD -c /Users/elias/prog/git5/src/allegro.c -o /Users/elias/prog/git5/build-iphone/ALLEGRO.build/Debug-iphoneos/allegro.build/Objects-normal/armv6/allegro.o

# x86 build for the simulator
# /Developer/Platforms/iPhoneSimulator.platform/Developer/usr/bin/gcc-4.2 -x c -arch i386 -fmessage-length=0 -pipe -Wno-trigraphs -fpascal-strings -O0 "-DCMAKE_INTDIR=\"Debug\"" -isysroot /Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator4.3.sdk -fexceptions -fasm-blocks -mmacosx-version-min=10.6 -gdwarf-2 -D__IPHONE_OS_VERSION_MIN_REQUIRED=40300 -I/Users/elias/prog/git5/build-iphone/lib/Debug/include -I/Users/elias/prog/git5/include -I/Users/elias/prog/git5/build-iphone/include -I/Users/elias/prog/git5/build-iphone/ALLEGRO.build/Debug-iphonesimulator/allegro.build/DerivedSources/i386 -I/Users/elias/prog/git5/build-iphone/ALLEGRO.build/Debug-iphonesimulator/allegro.build/DerivedSources -Wmost -Wno-four-char-constants -Wno-unknown-pragmas -F/Users/elias/prog/git5/build-iphone/lib/Debug -std=gnu99 -W -Wall -DDEBUGMODE=1 -DD3D_DEBUG_INFO -DALLEGRO_SRC -DALLEGRO_STATICLINK -DALLEGRO_LIB_BUILD -c /Users/elias/prog/git5/src/allegro.c -o /Users/elias/prog/git5/build-iphone/ALLEGRO.build/Debug-iphonesimulator/allegro.build/Objects-normal/i386/allegro.o


sim_env = Environment(ENV = os.environ)
phone_env = Environment(ENV = os.environ)

gccversion = '4.2'
iostarget = '4.3'
osxtarget = '10.'
 
platform_sim = 'iPhoneSimulator'
platform_phone = 'iPhoneOS'
 
arch_sim = 'i686'
arch_phone = 'armv6'
 
sim_bin_dir = '/Developer/Platforms/%s.platform/Developer/usr/bin' % platform_sim
phone_bin_dir = '/Developer/Platforms/%s.platform/Developer/usr/bin' % platform_phone

# Set environment paths
sim_env.PrependENVPath('PATH', sim_bin_dir)
phone_env.PrependENVPath('PATH', phone_bin_dir)

sdkroot_sim = '/Developer/Platforms/%s.platform/Developer/SDKs/%s%s.sdk' % (platform_sim, platform_sim, iostarget)
sdkroot_phone = '/Developer/Platforms/%s.platform/Developer/SDKs/%s%s.sdk' % (platform_phone, platform_phone, iostarget)

postfix = '-%s' % gccversion
def setGCC(env):
    def setup(x, post):
        return '%s%s' % (x, post)
    env['CC'] = setup('gcc', postfix)
    env['LD'] = setup('ld', postfix)
    env['CXX'] = setup('g++', postfix)
    env['AS'] = setup('as', postfix)
    env['AR'] = setup('ar', postfix)
    env['OBJCOPY'] = setup('objcopy', postfix)

setGCC(sim_env)
setGCC(phone_env)

def stringify(array):
    str = ''
    for item in array:
        str += item + ' '
    return [str.split(" ")]

cflags_sim = ['-arch %s' % arch_sim, '-pipe', '-mdynamic-no-pic', '-fvisibility=hidden', '-isysroot %s' % sdkroot_sim, '-std=gnu99', '-mmacosx-version-min=%s' % osxtarget]
ldflags_sim = ['-arch %s' % arch_sim, '-isysroot %s' % sdkroot_sim, '-Wl,-dead_strip', '-mmacosx-version-min=%s' % osxtarget]
defines_sim = Split("""
__IPHONE_OS_VERSION_MIN_REQUIRED=40300
DEBUGMODE=1
D3D_DEBUG_INFO
ALLEGRO_SRC
ALLEGRO_STATICLINK
ALLEGRO_LIB_BUILD""")
 
cflags_phone = ['-arch %s' % arch_phone, '-pipe', '-mdynamic-no-pic', '-fvisibility=hidden', '-isysroot %s' % sdkroot_phone, '-std=gnu99', '-miphoneos-version-min=%s' % iostarget]
ldflags_phone = ['-arch %s' % arch_phone, '-isysroot %s' % sdkroot_phone, '-Wl,-dead_strip', '-miphoneos-version-min=%s' % iostarget]
defines_phone = Split("""
DEBUGMODE=1
D3D_DEBUG_INFO
ALLEGRO_SRC
ALLEGRO_STATICLINK
ALLEGRO_LIB_BUILD""")

cflags =  Split("""
-g
-O2
-Wall
-Wmissing-prototypes
-ffast-math
-fno-strict-aliasing""")

cppflags = Split("""
-g
-O2
-Wall
-fno-strict-aliasing""")

includes = Split("""
include 
include/allegro5 
include/allegro5/inline 
include/allegro5/internal 
include/allegro5/opengl 
include/allegro5/platform 
src 
src/gp2xwiz 
src/iphone 
src/linux 
src/macosx 
src/misc 
src/opengl 
src/unix 
src/win 
src/x 
src/addons/primitives 
src/addons/primitives/allegro5 
src/addons/primitives/allegro5/internal""")

def setFlags(includes, cflags, cppflags, ldflags, defines, env):
    env.Append(CPATH = includes)
    env.Append(CPPPATH = includes)
    env.Append(CFLAGS = cflags)
    env.Append(CPPFLAGS = cppflags)
    env.Append(LDFLAGS = ldflags)
    env.Append(CDEFINES = defines)
    
setFlags(includes + ['-I%s/usr/include' % sdkroot_sim], cflags + stringify(cflags_sim), cppflags + stringify(cflags_sim), stringify(ldflags_sim), defines_sim, sim_env)
setFlags(includes + ['-I%s/usr/include' % sdkroot_phone], cflags + stringify(cflags_phone), cppflags + stringify(cflags_phone), stringify(ldflags_phone), defines_phone, phone_env)

source = Split("""
allegro.c
display.c
file_slice.c
iphone/EAGLView.h
iphone/EAGLView.m
iphone/ViewController.h
iphone/ViewController.m
iphone/allegroAppDelegate.h
iphone/allegroAppDelegate.m
iphone/iphone.h
iphone/iphone_display.c
iphone/iphone_joystick.m
iphone/iphone_keyboard.c
iphone/iphone_main.m
iphone/iphone_mouse.m
iphone/iphone_path.m
iphone/iphone_system.c
iphone/iphone_touch_input.m
math.c src/opengl/extensions.c
opengl/ogl_bitmap.c
opengl/ogl_display.c
opengl/ogl_draw.c
threads.c
unix/udrvlist.c
unix/ufdwatch.c
unix/ugfxdrv.c
unix/ujoydrv.c
unix/ukeybd.c
unix/umodules.c
unix/umouse.c
unix/upath.c
unix/utime.c
unix/uxthread.c
bitmap.c
display_settings.c
file_stdio.c
joynu.c
memblit.c
optimized.c
timernu.c
utf8.c
bitmap_io.c
dtor.c
fshook.c
keybdnu.c
memdraw.c
path.c
tls.c
blenders.c
events.c
fshook_stdio.c
libc.c
memory.c
pixels.c
touch_input.c
config.c
evtsrc.c
misc/aatree.c
misc/bstrlib.c
misc/bstrlib.txt
misc/list.c
misc/vector.c
scanline_drawers.c
transformations.c
convert.c
file.c
inline.c
mousenu.c
system.c
tri_soft.c""")

addons = Split("""
../addons/primitives/directx_shaders.cpp
../addons/primitives/high_primitives.c
../addons/primitives/line_soft.c
../addons/primitives/point_soft.c
../addons/primitives/polygon.c
../addons/primitives/polyline.c
../addons/primitives/prim_directx.cpp
../addons/primitives/prim_opengl.c
../addons/primitives/prim_soft.c
../addons/primitives/prim_util.c
../addons/primitives/primitives.c
../addons/primitives/triangulator.c
""")

def prepend(location, source):
    new_source = []
    for s in source:
        new_source.append('%s/%s' % (location, s))
    return new_source

sim_env.VariantDir('build/sim', 'src')
phone_env.VariantDir('build/phone', 'src')
sim_env.Library('allegro-sim', prepend('build/sim', source))
phone_env.Library('allegro-phone', prepend('build/phone', source))
